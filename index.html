<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C. Optimizar logística del reciclaje</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ===== DISEÑO ACTUALIZADO SIN SIDEBAR - CON BARRA SUPERIOR ===== */

/* Variables CSS */
:root {
  --primary-green: #27ae60;
  --secondary-green: #2ecc71;
  --dark-green: #1e8449;
  --light-green: #a9dfbf;
  --accent-blue: #3498db;
  --warning-orange: #f39c12;
  --danger-red: #e74c3c;
  --dark-gray: #2c3e50;
  --medium-gray: #7f8c8d;
  --light-gray: #ecf0f1;
  --white: #ffffff;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
  --border-radius: 12px;
  --transition: all 0.3s ease;
}

/* Reset base */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
  color: var(--dark-gray);
  line-height: 1.6;
}

/* === NUEVA BARRA SUPERIOR === */
.sidebar {
  display: none !important;
}

.topbar {
  width: 100%;
  background: linear-gradient(to right, var(--primary-green), var(--secondary-green));
  padding: 15px 30px;
  display: flex;
  justify-content: center;
  gap: 50px;
  position: fixed;
  top: 0;
  z-index: 1000;
  box-shadow: var(--shadow);
}

.topbar .nav-link {
  color: var(--white) !important;
  font-weight: 600;
  padding: 12px 20px;
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.topbar .nav-link:hover,
.topbar .nav-link.active {
  background-color: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

/* === CONTENIDO PRINCIPAL AJUSTADO === */
.main-content {
  margin-left: 0;
  padding-top: 100px;
  padding-left: 30px;
  padding-right: 30px;
}

/* === BOTÓN FLOTANTE PARA AGREGAR === */
.action-button-container {
  position: fixed;
  top: 100px;
  right: 30px;
  z-index: 999;
}

.action-button-container .btn {
  padding: 10px 20px;
  border-radius: var(--border-radius);
  background: linear-gradient(135deg, var(--accent-blue), #2980b9);
  color: var(--white);
  box-shadow: var(--shadow-hover);
  font-weight: bold;
}

.action-button-container .btn:hover {
  background: linear-gradient(135deg, #2980b9, var(--accent-blue));
  transform: scale(1.05);
}

/* === TARJETAS, TABLAS, FORMULARIOS, ETC. === */
.card {
  border: none;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  transition: var(--transition);
  overflow: hidden;
  background: var(--white);
}

.card:hover {
  box-shadow: var(--shadow-hover);
  transform: translateY(-2px);
}

.card-header {
  background: linear-gradient(135deg, var(--accent-blue) 0%, #2980b9 100%);
  color: var(--white);
  border: none;
  padding: 20px 25px;
  font-weight: 600;
  position: relative;
}

.card-body {
  padding: 25px;
}

.form-label {
  font-weight: 600;
  color: var(--dark-gray);
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.form-control,
.form-select {
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 12px 15px;
  transition: var(--transition);
  font-size: 0.95rem;
}

.form-control:focus,
.form-select:focus {
  border-color: var(--primary-green);
  box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
  outline: none;
}

.btn {
  border-radius: 8px;
  padding: 12px 20px;
  font-weight: 600;
  transition: var(--transition);
  border: none;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
  color: var(--white);
  box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--medium-gray), #95a5a6);
  color: var(--white);
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger-red), #c0392b);
  color: var(--white);
}

.table-responsive {
  border-radius: var(--border-radius);
  overflow: hidden;
}

.table thead th {
  background: linear-gradient(135deg, var(--dark-gray), #34495e);
  color: var(--white);
  border: none;
  padding: 18px 15px;
  font-weight: 600;
  font-size: 0.85rem;
}

.table tbody td {
  padding: 15px;
  vertical-align: middle;
  font-size: 0.9rem;
}

.table tbody tr:hover {
  background: linear-gradient(135deg, rgba(39, 174, 96, 0.05), rgba(46, 204, 113, 0.05));
  transform: scale(1.01);
}

/* Badge */
.badge {
  padding: 8px 12px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.bg-success {
  background: linear-gradient(135deg, var(--secondary-green), var(--primary-green)) !important;
}

.bg-secondary {
  background: linear-gradient(135deg, var(--medium-gray), #95a5a6) !important;
}

/* Responsive */
@media (max-width: 768px) {
  .topbar {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }

  .action-button-container {
    position: static;
    margin: 20px auto;
    text-align: center;
  }

  .main-content {
    padding: 20px 15px;
  }
}

  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="text-center mb-4">
      <h4>♻️ Reciclaje Escolar</h4>
    </div>
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="showSection('rutas')">
          <i class="fas fa-route"></i> Rutas
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showSection('zonas')">
          <i class="fas fa-map-marked-alt"></i> Zonas
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Sección de Rutas -->
    <div id="section-rutas">
      <div class="d-flex justify-content-between align-items-center mb-4 title-bar">
        <h2 class="mb-0"><i class="fas fa-route"></i> C. Optimizar logística del reciclaje</h2>
        <button class="btn btn-light" onclick="mostrarFormRuta(true)">
          <i class="fas fa-plus"></i> Nueva Ruta
        </button>
      </div>

      <!-- Formulario de Ruta -->
      <div id="form-ruta" class="card mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
          <h5>Nueva Ruta</h5>
        </div>
        <div class="card-body">
          <form id="rutaForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Nombre de la Ruta*</label>
                <input type="text" id="ruta-nombre" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Zona*</label>
                <select id="ruta-zona" class="form-select" required>
                  <option value="">Seleccionar zona...</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Día*</label>
                <select id="ruta-dia" class="form-select" required>
                  <option value="">Seleccionar día...</option>
                  <option value="Lunes">Lunes</option>
                  <option value="Martes">Martes</option>
                  <option value="Miércoles">Miércoles</option>
                  <option value="Jueves">Jueves</option>
                  <option value="Viernes">Viernes</option>
                  <option value="Sábado">Sábado</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Hora Inicio*</label>
                <input type="time" id="ruta-hora-inicio" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Hora Fin*</label>
                <input type="time" id="ruta-hora-fin" class="form-control" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Vehículo*</label>
                <input type="text" id="ruta-vehiculo" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Conductor*</label>
                <input type="text" id="ruta-conductor" class="form-control" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Distancia (km)*</label>
                <input type="number" id="ruta-distancia" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Estado*</label>
                <select id="ruta-estado" class="form-select" required>
                  <option value="activa">Activa</option>
                  <option value="inactiva">Inactiva</option>
                </select>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" onclick="mostrarFormRuta(false)">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Listado de Rutas -->
      <div class="card">
        <div class="card-header">
          <h5>Listado de Rutas</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Zona</th>
                  <th>Día</th>
                  <th>Horario</th>
                  <th>Vehículo</th>
                  <th>Distancia</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="rutas-table">
                <!-- Las rutas se cargarán aquí dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección de Zonas -->
    <div id="section-zonas" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-4 title-bar">
        <h2 class="mb-0"><i class="fas fa-map-marked-alt"></i> Gestión de Zonas</h2>
        <button class="btn btn-light" onclick="mostrarFormZona(true)">
          <i class="fas fa-plus"></i> Nueva Zona
        </button>
      </div>

      <!-- Formulario de Zona -->
      <div id="form-zona" class="card mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
          <h5>Nueva Zona</h5>
        </div>
        <div class="card-body">
          <form id="zonaForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Nombre*</label>
                <input type="text" id="zona-nombre" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Código*</label>
                <input type="text" id="zona-codigo" class="form-control" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Tipo*</label>
                <select id="zona-tipo" class="form-select" required>
                  <option value="">Seleccionar tipo...</option>
                  <option value="comercial">Comercial</option>
                  <option value="residencial">Residencial</option>
                  <option value="academico">Académico</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Población*</label>
                <input type="number" id="zona-poblacion" class="form-control" required>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" onclick="mostrarFormZona(false)">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Listado de Zonas -->
      <div class="card">
        <div class="card-header">
          <h5>Listado de Zonas</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Código</th>
                  <th>Tipo</th>
                  <th>Población</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="zonas-table">
                <!-- Las zonas se cargarán aquí dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS + Font Awesome -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  
  <!-- JavaScript -->
  <script>
    // URL base del backend
    const API_URL = 'http://localhost:3000/api';
    
    // Mostrar sección seleccionada
    function showSection(section) {
      document.getElementById('section-rutas').style.display = 'none';
      document.getElementById('section-zonas').style.display = 'none';
      document.getElementById(`section-${section}`).style.display = 'block';
      
      // Actualizar clase activa en el menú
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`a[onclick="showSection('${section}')"]`).classList.add('active');
      
      if (section === 'rutas') cargarRutas();
      if (section === 'zonas') cargarZonas();
    }
    
    // Mostrar sección de rutas por defecto
    showSection('rutas');

    // ===== FUNCIONES PARA RUTAS =====
    async function cargarRutas() {
      try {
        const response = await fetch(`${API_URL}/rutas`);
        if (!response.ok) throw new Error('Error al cargar rutas');
        const rutas = await response.json();
        renderizarRutas(rutas);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar rutas: ' + error.message);
      }
    }

    function renderizarRutas(rutas) {
      const tbody = document.getElementById('rutas-table');
      tbody.innerHTML = rutas.map(ruta => `
        <tr>
          <td>${ruta.nombre}</td>
          <td>${ruta.zona_nombre} (${ruta.zona_codigo})</td>
          <td>${ruta.dia}</td>
          <td>${ruta.hora_inicio} - ${ruta.hora_fin}</td>
          <td>${ruta.vehiculo}</td>
          <td>${ruta.distancia_km} km</td>
          <td>
            <span class="badge ${ruta.estado === 'activa' ? 'bg-success' : 'bg-secondary'}">
              ${ruta.estado}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="eliminarRuta('${ruta._id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function cargarZonasParaSelect() {
      try {
        const response = await fetch(`${API_URL}/zonas`);
        if (!response.ok) throw new Error('Error al cargar zonas');
        const zonas = await response.json();
        const select = document.getElementById('ruta-zona');
        
        select.innerHTML = '<option value="">Seleccionar zona...</option>' + 
          zonas.map(z => `<option value="${z.codigo}" data-nombre="${z.nombre}">${z.nombre} (${z.codigo})</option>`).join('');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar zonas: ' + error.message);
      }
    }

    function mostrarFormRuta(mostrar) {
      const form = document.getElementById('form-ruta');
      
      if (mostrar) {
        document.getElementById('rutaForm').reset();
        cargarZonasParaSelect();
        form.style.display = 'block';
      } else {
        form.style.display = 'none';
      }
    }

    async function eliminarRuta(id) {
      if (confirm('¿Estás seguro de eliminar esta ruta?')) {
        try {
          const response = await fetch(`${API_URL}/rutas/${id}`, { 
            method: 'DELETE' 
          });
          
          if (!response.ok) throw new Error('Error al eliminar ruta');
          
          await cargarRutas();
          alert('Ruta eliminada correctamente');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar ruta: ' + error.message);
        }
      }
    }

    document.getElementById('rutaForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const zonaSelect = document.getElementById('ruta-zona');
      const zonaNombre = zonaSelect.options[zonaSelect.selectedIndex]?.dataset.nombre || '';
      
      const ruta = {
        nombre: document.getElementById('ruta-nombre').value,
        zona_codigo: zonaSelect.value,
        zona_nombre: zonaNombre,
        dia: document.getElementById('ruta-dia').value,
        hora_inicio: document.getElementById('ruta-hora-inicio').value,
        hora_fin: document.getElementById('ruta-hora-fin').value,
        vehiculo: document.getElementById('ruta-vehiculo').value,
        conductor: document.getElementById('ruta-conductor').value,
        distancia_km: document.getElementById('ruta-distancia').value,
        estado: document.getElementById('ruta-estado').value
      };
      
      try {
        const response = await fetch(`${API_URL}/rutas`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(ruta)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error en la respuesta del servidor');
        }
        
        mostrarFormRuta(false);
        await cargarRutas();
        alert('Ruta registrada correctamente');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar ruta: ' + error.message);
      }
    });

    // ===== FUNCIONES PARA ZONAS =====
    async function cargarZonas() {
      try {
        const response = await fetch(`${API_URL}/zonas`);
        if (!response.ok) throw new Error('Error al cargar zonas');
        const zonas = await response.json();
        renderizarZonas(zonas);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar zonas: ' + error.message);
      }
    }

    function renderizarZonas(zonas) {
      const tbody = document.getElementById('zonas-table');
      tbody.innerHTML = zonas.map(zona => `
        <tr>
          <td>${zona.nombre}</td>
          <td>${zona.codigo}</td>
          <td>${zona.tipo}</td>
          <td>${zona.poblacion}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="eliminarZona('${zona._id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function mostrarFormZona(mostrar) {
      const form = document.getElementById('form-zona');
      
      if (mostrar) {
        document.getElementById('zonaForm').reset();
        form.style.display = 'block';
      } else {
        form.style.display = 'none';
      }
    }

    async function eliminarZona(id) {
      if (confirm('¿Estás seguro de eliminar esta zona?')) {
        try {
          const response = await fetch(`${API_URL}/zonas/${id}`, { 
            method: 'DELETE' 
          });
          
          if (!response.ok) throw new Error('Error al eliminar zona');
          
          await cargarZonas();
          alert('Zona eliminada correctamente');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al eliminar zona: ' + error.message);
        }
      }
    }

    document.getElementById('zonaForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const zona = {
        nombre: document.getElementById('zona-nombre').value,
        codigo: document.getElementById('zona-codigo').value,
        tipo: document.getElementById('zona-tipo').value,
        poblacion: document.getElementById('zona-poblacion').value
      };
      
      try {
        const response = await fetch(`${API_URL}/zonas`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(zona)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error en la respuesta del servidor');
        }
        
        mostrarFormZona(false);
        await cargarZonas();
        alert('Zona registrada correctamente');
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar zona: ' + error.message);
      }
    });
    // ===== FUNCIONALIDAD DE ACTUALIZACIÓN DE DATOS =====

// Variables globales para manejar el modo de edición
let editandoRuta = null;
let editandoZona = null;

// ===== FUNCIONES PARA ACTUALIZAR RUTAS =====
function editarRuta(id, ruta) {
  editandoRuta = id;
  
  // Llenar el formulario con los datos existentes
  document.getElementById('ruta-nombre').value = ruta.nombre;
  document.getElementById('ruta-zona').value = ruta.zona_codigo;
  document.getElementById('ruta-dia').value = ruta.dia;
  document.getElementById('ruta-hora-inicio').value = ruta.hora_inicio;
  document.getElementById('ruta-hora-fin').value = ruta.hora_fin;
  document.getElementById('ruta-vehiculo').value = ruta.vehiculo;
  document.getElementById('ruta-conductor').value = ruta.conductor;
  document.getElementById('ruta-distancia').value = ruta.distancia_km;
  document.getElementById('ruta-estado').value = ruta.estado;
  
  // Cambiar el título y botón del formulario
  document.querySelector('#form-ruta .card-header h5').textContent = 'Editar Ruta';
  document.querySelector('#rutaForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Actualizar';
  
  // Mostrar formulario y cargar zonas
  cargarZonasParaSelect();
  mostrarFormRuta(true);
}

async function actualizarRuta(id, rutaData) {
  try {
    // Filtrar campos vacíos antes de enviar
    const datosLimpios = {};
    Object.keys(rutaData).forEach(key => {
      if (rutaData[key] !== '' && rutaData[key] !== null && rutaData[key] !== undefined) {
        datosLimpios[key] = rutaData[key];
      }
    });
    
    const response = await fetch(`${API_URL}/rutas/${id}`, {
      method: 'PATCH', // Usar PATCH para actualizaciones parciales
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datosLimpios)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al actualizar ruta');
    }
    
    return await response.json();
  } catch (error) {
    throw error;
  }
}

// ===== FUNCIONES PARA ACTUALIZAR ZONAS =====
function editarZona(id, zona) {
  editandoZona = id;
  
  // Llenar el formulario con los datos existentes
  document.getElementById('zona-nombre').value = zona.nombre;
  document.getElementById('zona-codigo').value = zona.codigo;
  document.getElementById('zona-tipo').value = zona.tipo;
  document.getElementById('zona-poblacion').value = zona.poblacion;
  
  // Cambiar el título y botón del formulario
  document.querySelector('#form-zona .card-header h5').textContent = 'Editar Zona';
  document.querySelector('#zonaForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Actualizar';
  
  // Mostrar formulario
  mostrarFormZona(true);
}

async function actualizarZona(id, zonaData) {
  try {
    // Filtrar campos vacíos antes de enviar
    const datosLimpios = {};
    Object.keys(zonaData).forEach(key => {
      if (zonaData[key] !== '' && zonaData[key] !== null && zonaData[key] !== undefined) {
        datosLimpios[key] = zonaData[key];
      }
    });
    
    const response = await fetch(`${API_URL}/zonas/${id}`, {
      method: 'PATCH', // Usar PATCH para actualizaciones parciales
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datosLimpios)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al actualizar zona');
    }
    
    return await response.json();
  } catch (error) {
    throw error;
  }
}

// ===== MODIFICAR FUNCIONES DE RENDERIZADO PARA INCLUIR BOTÓN EDITAR =====

// Actualizar la función renderizarRutas (reemplazar la existente)
function renderizarRutas(rutas) {
  const tbody = document.getElementById('rutas-table');
  tbody.innerHTML = rutas.map(ruta => `
    <tr>
      <td>${ruta.nombre}</td>
      <td>${ruta.zona_nombre} (${ruta.zona_codigo})</td>
      <td>${ruta.dia}</td>
      <td>${ruta.hora_inicio} - ${ruta.hora_fin}</td>
      <td>${ruta.vehiculo}</td>
      <td>${ruta.distancia_km} km</td>
      <td>
        <span class="badge ${ruta.estado === 'activa' ? 'bg-success' : 'bg-secondary'}">
          ${ruta.estado}
        </span>
      </td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editarRuta('${ruta._id}', ${JSON.stringify(ruta).replace(/"/g, '&quot;')})">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="eliminarRuta('${ruta._id}')">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

// Actualizar la función renderizarZonas (reemplazar la existente)
function renderizarZonas(zonas) {
  const tbody = document.getElementById('zonas-table');
  tbody.innerHTML = zonas.map(zona => `
    <tr>
      <td>${zona.nombre}</td>
      <td>${zona.codigo}</td>
      <td>${zona.tipo}</td>
      <td>${zona.poblacion}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editarZona('${zona._id}', ${JSON.stringify(zona).replace(/"/g, '&quot;')})">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="eliminarZona('${zona._id}')">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

// ===== MODIFICAR EVENT LISTENERS PARA MANEJAR ACTUALIZACIÓN =====

// Modificar el event listener del formulario de rutas (reemplazar el existente)
document.getElementById('rutaForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const zonaSelect = document.getElementById('ruta-zona');
  const zonaNombre = zonaSelect.options[zonaSelect.selectedIndex]?.dataset.nombre || '';
  
  const ruta = {
    nombre: document.getElementById('ruta-nombre').value,
    zona_codigo: zonaSelect.value,
    zona_nombre: zonaNombre,
    dia: document.getElementById('ruta-dia').value,
    hora_inicio: document.getElementById('ruta-hora-inicio').value,
    hora_fin: document.getElementById('ruta-hora-fin').value,
    vehiculo: document.getElementById('ruta-vehiculo').value,
    conductor: document.getElementById('ruta-conductor').value,
    distancia_km: document.getElementById('ruta-distancia').value,
    estado: document.getElementById('ruta-estado').value
  };
  
  try {
    if (editandoRuta) {
      // ACTUALIZAR ruta existente
      await actualizarRuta(editandoRuta, ruta);
      alert('Ruta actualizada correctamente');
      editandoRuta = null;
    } else {
      // CREAR nueva ruta
      const response = await fetch(`${API_URL}/rutas`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(ruta)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error en la respuesta del servidor');
      }
      
      alert('Ruta registrada correctamente');
    }
    
    // Resetear formulario y recargar datos
    resetearFormularioRuta();
    mostrarFormRuta(false);
    await cargarRutas();
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error al guardar ruta: ' + error.message);
  }
});

// Modificar el event listener del formulario de zonas (reemplazar el existente)
document.getElementById('zonaForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const zona = {
    nombre: document.getElementById('zona-nombre').value,
    codigo: document.getElementById('zona-codigo').value,
    tipo: document.getElementById('zona-tipo').value,
    poblacion: document.getElementById('zona-poblacion').value
  };
  
  try {
    if (editandoZona) {
      // ACTUALIZAR zona existente
      await actualizarZona(editandoZona, zona);
      alert('Zona actualizada correctamente');
      editandoZona = null;
    } else {
      // CREAR nueva zona
      const response = await fetch(`${API_URL}/zonas`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(zona)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error en la respuesta del servidor');
      }
      
      alert('Zona registrada correctamente');
    }
    
    // Resetear formulario y recargar datos
    resetearFormularioZona();
    mostrarFormZona(false);
    await cargarZonas();
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error al guardar zona: ' + error.message);
  }
});

// ===== FUNCIONES AUXILIARES PARA RESETEAR FORMULARIOS =====
function resetearFormularioRuta() {
  document.querySelector('#form-ruta .card-header h5').textContent = 'Nueva Ruta';
  document.querySelector('#rutaForm button[type="submit"]').innerHTML = 'Guardar';
  editandoRuta = null;
}

function resetearFormularioZona() {
  document.querySelector('#form-zona .card-header h5').textContent = 'Nueva Zona';
  document.querySelector('#zonaForm button[type="submit"]').innerHTML = 'Guardar';
  editandoZona = null;
}

// Modificar las funciones mostrarForm para resetear cuando sea nueva entrada
const mostrarFormRutaOriginal = mostrarFormRuta;
mostrarFormRuta = function(mostrar) {
  if (mostrar && !editandoRuta) {
    resetearFormularioRuta();
  }
  mostrarFormRutaOriginal(mostrar);
};

const mostrarFormZonaOriginal = mostrarFormZona;
mostrarFormZona = function(mostrar) {
  if (mostrar && !editandoZona) {
    resetearFormularioZona();
  }
  mostrarFormZonaOriginal(mostrar);
};
  </script>
</body>
</html>